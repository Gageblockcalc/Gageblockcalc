<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Free gage block calculator for 81-piece imperial set. Find combinations up to 20 inches with auto-verification.">
    <meta name="theme-color" content="#007bff">
    <title>Gage Block Calculator</title>
    <link rel="manifest" href="/gageblockcalc/manifest.json">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-x: hidden;
        }
        .container {
            width: 90vw;
            max-width: 600px;
            min-height: 100%;
            background: #fff;
            padding: 2vw 4vw;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        h1 {
            font-size: calc(1.3rem + 1vw);
            text-align: center;
            margin: 0 0 2vw 0;
            color: #333;
        }
        .input-section {
            margin-bottom: 2vw;
            display: flex;
            flex-wrap: wrap;
            gap: 1vw;
        }
        input[type="number"] {
            flex: 1;
            padding: 1.2vw;
            font-size: calc(0.9rem + 0.5vw);
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
        }
        select.block-count {
            width: 60px;
            padding: 0.5vw;
            margin-left: 1vw;
            font-size: calc(0.8rem + 0.4vw);
            border: 1px solid #ced4da;
            border-radius: 6px;
        }
        .button {
            padding: 1vw 1.5vw;
            font-size: calc(0.8rem + 0.5vw);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            transition: background-color 0.2s;
            touch-action: manipulation;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button-secondary {
            background-color: #6c757d;
        }
        .button-secondary:hover {
            background-color: #5a6268;
        }
        .collapsible-header {
            background-color: #f1f3f5;
            padding: 1vw;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 1vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .block-selection {
            max-height: 40vh;
            overflow-y: auto;
            padding: 1vw;
            border: 1px solid #ced4da;
            border-radius: 6px;
            display: none;
        }
        .block-selection.open {
            display: block;
        }
        .block-item {
            display: flex;
            align-items: center;
            margin-bottom: 1vw;
        }
        .block-item input[type="checkbox"] {
            margin-right: 1vw;
            transform: scale(1.5);
        }
        .block-item label {
            font-size: calc(0.8rem + 0.4vw);
            color: #333;
            flex: 1;
        }
        .results {
            margin-top: 2vw;
            flex-grow: 1;
        }
        .combination {
            background: #f8f9fa;
            padding: 1.2vw;
            margin-bottom: 1vw;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        .error {
            color: #dc3545;
            text-align: center;
            font-size: calc(0.8rem + 0.4vw);
            margin-bottom: 1vw;
        }
        .loading {
            color: #007bff;
            text-align: center;
            font-size: calc(0.8rem + 0.4vw);
            margin-bottom: 1vw;
        }
        .footer {
            margin-top: 2vw;
            font-size: calc(0.7rem + 0.3vw);
            color: #6c757d;
            text-align: center;
        }
        @media (max-width: 600px) {
            .container {
                padding: 3vw;
            }
            h1 {
                font-size: calc(1.1rem + 1vw);
            }
            input[type="number"], .button {
                padding: 2vw;
                font-size: calc(0.8rem + 0.5vw);
            }
            select.block-count {
                width: 50px;
                padding: 1vw;
            }
            .block-item label {
                font-size: calc(0.7rem + 0.4vw);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gage Block Calculator</h1>
        <div class="input-section">
            <input type="number" id="target" placeholder="Target dimension (inches)" step="0.0001" min="0" max="20" aria-label="Target dimension in inches">
        </div>
        <div class="collapsible-header" id="blockHeader">
            <span>Select Available Blocks</span>
            <span>â–¼</span>
        </div>
        <div class="block-selection" id="blockSelection">
            <!-- Block checkboxes and count dropdowns populated by JavaScript -->
        </div>
        <div class="results" id="results"></div>
        <div class="footer">Made by Nicholas Duncan 2025</div>
    </div>

    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/gageblockcalc/sw.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }

        // 81-piece imperial gage block set (in inches)
        const blockSet = [
            0.1001, 0.1002, 0.1003, 0.1004, 0.1005, 0.1006, 0.1007, 0.1008, 0.1009,
            0.101, 0.102, 0.103, 0.104, 0.105, 0.106, 0.107, 0.108, 0.109,
            0.110, 0.111, 0.112, 0.113, 0.114, 0.115, 0.116, 0.117, 0.118, 0.119,
            0.120, 0.121, 0.122, 0.123, 0.124, 0.125, 0.126, 0.127, 0.128, 0.129,
            0.130, 0.131, 0.132, 0.133, 0.134, 0.135, 0.136, 0.137, 0.138, 0.139,
            0.140, 0.141, 0.142, 0.143, 0.144, 0.145, 0.146, 0.147, 0.148, 0.149,
            0.050, 0.100, 0.150, 0.200, 0.250, 0.300, 0.350, 0.400, 0.450, 0.500,
            0.550, 0.600, 0.650, 0.700, 0.750, 0.800, 0.850, 0.900, 0.950,
            1.000, 2.000, 3.000, 4.000
        ];

        // Initialize block availability (default: 1 per block)
        let blockAvailability = {};
        let blockChecked = {};
        blockSet.forEach(block => {
            blockAvailability[block] = 1;
            blockChecked[block] = true;
        });

        // Load saved settings from localStorage
        function loadSavedSettings() {
            try {
                const savedAvailability = localStorage.getItem('blockAvailability');
                const savedChecked = localStorage.getItem('blockChecked');
                if (savedAvailability) {
                    blockAvailability = JSON.parse(savedAvailability);
                    blockSet.forEach(block => {
                        if (!(block in blockAvailability)) {
                            blockAvailability[block] = 1;
                        }
                    });
                }
                if (savedChecked) {
                    blockChecked = JSON.parse(savedChecked);
                    blockSet.forEach(block => {
                        if (!(block in blockChecked)) {
                            blockChecked[block] = true;
                        }
                    });
                }
                console.log('Loaded saved settings from localStorage');
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            try {
                localStorage.setItem('blockAvailability', JSON.stringify(blockAvailability));
                localStorage.setItem('blockChecked', JSON.stringify(blockChecked));
                console.log('Settings saved to localStorage');
            } catch (e) {
                console.error('Error saving settings:', e);
            }
        }

        // Populate block selection asynchronously
        const blockSelection = document.getElementById('blockSelection');
        function populateBlocks() {
            try {
                loadSavedSettings();
                blockSelection.innerHTML = `
                    <div class="input-section">
                        <button class="button" id="selectAllBtn">Select All</button>
                        <button class="button button-secondary" id="deselectAllBtn">Deselect All</button>
                    </div>
                `;
                blockSet.forEach(block => {
                    const div = document.createElement('div');
                    div.className = 'block-item';
                    div.innerHTML = `
                        <input type="checkbox" id="block-${block}" value="${block}" ${blockChecked[block] ? 'checked' : ''} aria-label="Block size ${block} inches">
                        <label for="block-${block}">${block} inches</label>
                        <select class="block-count" id="count-${block}" ${blockChecked[block] ? '' : 'disabled'} aria-label="Number of ${block} inch blocks available">
                            <option value="1" ${blockAvailability[block] === 1 ? 'selected' : ''}>1</option>
                            <option value="2" ${blockAvailability[block] === 2 ? 'selected' : ''}>2</option>
                            <option value="3" ${blockAvailability[block] === 3 ? 'selected' : ''}>3</option>
                            <option value="4" ${blockAvailability[block] === 4 ? 'selected' : ''}>4</option>
                            <option value="5" ${blockAvailability[block] === 5 ? 'selected' : ''}>5</option>
                        </select>
                    `;
                    blockSelection.appendChild(div);
                });
                console.log('Blocks populated successfully');

                // Attach event listeners for buttons
                const selectAllBtn = document.getElementById('selectAllBtn');
                const deselectAllBtn = document.getElementById('deselectAllBtn');

                selectAllBtn.addEventListener('click', () => {
                    try {
                        blockSet.forEach(block => {
                            const checkbox = document.getElementById(`block-${block}`);
                            const countSelect = document.getElementById(`count-${block}`);
                            checkbox.checked = true;
                            countSelect.value = 5;
                            countSelect.disabled = false;
                            blockAvailability[block] = 5;
                            blockChecked[block] = true;
                        });
                        saveSettings();
                        updateAvailableBlocks();
                        const target = parseFloat(targetInput.value) || 0;
                        updateResults(target);
                        console.log('Select All clicked');
                    } catch (e) {
                        console.error('Select all error:', e);
                        document.getElementById('results').innerHTML = '<div class="error">Error selecting blocks. Please try again.</div>';
                    }
                });

                deselectAllBtn.addEventListener('click', () => {
                    try {
                        blockSet.forEach(block => {
                            const checkbox = document.getElementById(`block-${block}`);
                            const countSelect = document.getElementById(`count-${block}`);
                            checkbox.checked = false;
                            countSelect.value = 1;
                            countSelect.disabled = true;
                            blockAvailability[block] = 0;
                            blockChecked[block] = false;
                        });
                        saveSettings();
                        updateAvailableBlocks();
                        const target = parseFloat(targetInput.value) || 0;
                        updateResults(target);
                        console.log('Deselect All clicked');
                    } catch (e) {
                        console.error('Deselect all error:', e);
                        document.getElementById('results').innerHTML = '<div class="error">Error deselecting blocks. Please try again.</div>';
                    }
                });

                // Attach event listeners for count dropdowns
                blockSet.forEach(block => {
                    const countSelect = document.getElementById(`count-${block}`);
                    countSelect.addEventListener('change', () => {
                        try {
                            const value = parseInt(countSelect.value);
                            blockAvailability[block] = value;
                            const checkbox = document.getElementById(`block-${block}`);
                            checkbox.checked = value > 0;
                            blockChecked[block] = checkbox.checked;
                            countSelect.disabled = !checkbox.checked;
                            saveSettings();
                            updateAvailableBlocks();
                            const target = parseFloat(targetInput.value) || 0;
                            updateResults(target);
                            console.log(`Count updated for block ${block}: ${value}`);
                        } catch (e) {
                            console.error('Count select error:', e);
                            document.getElementById('results').innerHTML = '<div class="error">Error updating block count. Please try again.</div>';
                        }
                    });
                });
            } catch (e) {
                console.error('Error populating blocks:', e);
                document.getElementById('results').innerHTML = '<div class="error">Error loading block selection. Please refresh.</div>';
            }
        }
        setTimeout(populateBlocks, 0);

        // Update available blocks based on checkboxes and counts
        let availableBlocks = [];
        function updateAvailableBlocks() {
            availableBlocks = [];
            blockSet.forEach(block => {
                const checkbox = document.getElementById(`block-${block}`);
                const count = blockAvailability[block] || 0;
                if (checkbox.checked && count > 0) {
                    availableBlocks.push(block);
                }
            });
            console.log('Available blocks updated:', availableBlocks);
        }

        // Subset sum respecting block availability
        function findCombinations(target, blocks, maxStack = 20) {
            const results = [];
            const tolerance = 0.0001;
            const maxCombinations = 5;
            let iterations = 0;
            const maxIterations = 100000;

            function subsetSum(blocks, target, partial = [], blockCounts = {}, partialSum = 0, index = 0) {
                if (iterations > maxIterations || results.length >= maxCombinations) return;
                iterations++;
                if (partialSum > maxStack + tolerance) return;
                if (Math.abs(partialSum - target) <= tolerance && partial.length > 0) {
                    results.push([...partial]);
                    return;
                }
                if (partialSum > target + tolerance || index >= blocks.length) return;

                const block = blocks[index];
                const count = blockCounts[block] || 0;
                const maxCount = blockAvailability[block] || 0;
                if (count < maxCount && partialSum + block <= maxStack + tolerance) {
                    blockCounts[block] = count + 1;
                    subsetSum(blocks, target, [...partial, block], blockCounts, partialSum + block, index);
                    blockCounts[block] = count;
                }
                subsetSum(blocks, target, partial, blockCounts, partialSum, index + 1);
            }

            try {
                const sortedBlocks = [...blocks].sort((a, b) => b - a);
                subsetSum(sortedBlocks, target, [], {}, 0, 0);
                console.log(`Combinations found: ${results.length}, iterations: ${iterations}`);
                return results.sort((a, b) => a.length - b.length || a.reduce((s, n) => s + n, 0) - b.reduce((s, n) => s + n, 0)).slice(0, 5);
            } catch (e) {
                console.error('Calculation error:', e);
                return [];
            }
        }

        // Verify math
        function verifyMath(combination, target) {
            try {
                const sum = combination.reduce((a, b) => a + Number(b), 0);
                return Math.abs(sum - target) <= 0.0001 ? 'âœ“ Verified' : 'âœ— Error';
            } catch (e) {
                console.error('Verification error:', e);
                return 'âœ— Error';
            }
        }

        // Update results
        function updateResults(target) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Calculating...</div>';

            setTimeout(() => {
                try {
                    resultsDiv.innerHTML = '';
                    if (!target || target <= 0 || target > 20) {
                        resultsDiv.innerHTML = '<div class="error">Please enter a dimension between 0 and 20 inches</div>';
                        return;
                    }

                    updateAvailableBlocks();
                    if (availableBlocks.length === 0) {
                        resultsDiv.innerHTML = '<div class="error">No blocks available. Please select at least one block with availability.</div>';
                        return;
                    }

                    const combinations = findCombinations(target, availableBlocks);
                    if (combinations.length === 0) {
                        resultsDiv.innerHTML = '<div class="error">No valid combinations found. Try selecting more blocks or increasing availability.</div>';
                        return;
                    }

                    combinations.forEach((combo, index) => {
                        const sum = combo.reduce((a, b) => a + Number(b), 0).toFixed(4);
                        const verification = verifyMath(combo, target);
                        const div = document.createElement('div');
                        div.className = 'combination';
                        div.innerHTML = `
                            <strong>Combination ${index + 1}:</strong> ${combo.join(' + ')} = ${sum} inches (${verification})
                        `;
                        resultsDiv.appendChild(div);
                    });
                } catch (e) {
                    resultsDiv.innerHTML = '<div class="error">Error calculating combinations. Please try again.</div>';
                    console.error('Update error:', e);
                }
            }, 0);
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Collapsible block selection
        const blockHeader = document.getElementById('blockHeader');
        blockHeader.addEventListener('click', () => {
            try {
                blockSelection.classList.toggle('open');
                blockHeader.querySelector('span:last-child').textContent = blockSelection.classList.contains('open') ? 'â–²' : 'â–¼';
                console.log('Collapsible toggled');
            } catch (e) {
                console.error('Collapsible toggle error:', e);
            }
        });

        // Handle input and checkbox changes
        const targetInput = document.getElementById('target');
        const debouncedUpdate = debounce((target) => {
            updateResults(target);
        }, 500);
        targetInput.addEventListener('input', () => {
            try {
                const target = parseFloat(targetInput.value);
                debouncedUpdate(target);
                console.log('Input updated:', target);
            } catch (e) {
                console.error('Input error:', e);
                document.getElementById('results').innerHTML = '<div class="error">Invalid input. Please try again.</div>';
            }
        });

        blockSelection.addEventListener('change', (e) => {
            try {
                if (e.target.type === 'checkbox') {
                    const block = parseFloat(e.target.value);
                    const countSelect = document.getElementById(`count-${block}`);
                    countSelect.disabled = !e.target.checked;
                    blockChecked[block] = e.target.checked;
                    if (!e.target.checked) {
                        countSelect.value = 1;
                        blockAvailability[block] = 0;
                    } else if (blockAvailability[block] === 0) {
                        countSelect.value = 1;
                        blockAvailability[block] = 1;
                    }
                    saveSettings();
                    updateAvailableBlocks();
                    const target = parseFloat(targetInput.value) || 0;
                    updateResults(target);
                    console.log(`Checkbox changed for block ${block}: ${e.target.checked}`);
                }
            } catch (e) {
                console.error('Checkbox change error:', e);
                document.getElementById('results').innerHTML = '<div class="error">Error updating blocks. Please try again.</div>';
            }
        });

        // Log successful load
        console.log('Page loaded successfully');
    </script>
</body>
</html>
